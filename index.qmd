---
title: "Work about the bathymetry estimation of Sainte Marie Lagoon?"
author: "Simon Oiry"
format:
  html:
    css: styles.css
editor: visual
editor_options: 
  chunk_output_type: console
---

::: {style="text-align: center; margin-top: 20px;"}
<button onclick="window.open(&#39;https://github.com/SigOiry/Mada_Gulf_Bathymetry&#39;, &#39;_blank&#39;);" style="padding: 10px 20px; background-color: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">

Visit the Github repository
</button>
:::

```{r leafletmapofBathy}
#| fig-cap: Map of the Bathymetry of the gulf od Sainte Marie
#| label: fig-Map_Bathy
#| echo: false
#| error: false
#| message: false
#| eval: true
#| warning: false
#| out-width: "95%"
# Install once if needed:
# install.packages(c("terra", "sf", "leaflet", "leafem", "viridisLite"))

library(terra)
library(sf)
library(leaflet)
library(leafem)
library(viridisLite)
library(tidyverse)

## 1. Load your data ---------------------------------------------------------

# Original bathymetry: depth in metres (0–30 m)
bathy <- rast("Data/Bathy_Lagoon_20250613_S2_Swampy.tif") %>% 
  project("EPSG:4326")

# Polygons: sf object with a column "ID"
polys <- st_read("Data/NBS_modules_Dec_2025.shp", quiet =T)

# Make sure both are in the same CRS
polys <- st_transform(polys, crs(bathy))


## 2. Create a DISPLAY-ONLY raster with values "squashed" to 0–3 m ----------

# This does NOT alter `bathy`. We create a new raster just for colors.
# Values <0 -> 0; values >3 -> 3; 0–3 unchanged.
bathy_display <- app(
  bathy,
  fun = function(x) {
    x[x < 0] <- 0
    x[x > 2] <- 2
    x
  }
)

# Colour palette focused on [0, 3]
pal_bathy <- colorNumeric(
  palette  = viridis(256),
  domain   = c(0, 2),
  na.color = "transparent"
)


## 3. Build the leaflet map --------------------------------------------------

m <- leaflet() |>
  # addTiles(group = "Base map") %>% 
  addProviderTiles(
    providers$Esri.WorldImagery,
    group = "Esri Satellite"
  ) %>% 
  
  # Bathymetry layer (display only, 0–3 m scale; deeper values = color of 3 m)
  addRasterImage(
    x       = bathy_display,
    colors  = pal_bathy,
    project = TRUE,
    # opacity = 0.8,
    group   = "Bathymetry"
  ) %>% 
  
  addLegend(
    pal       = pal_bathy,
    values    = c(0, 2),
    title     = "Depth (m)",
    position  = "bottomright",
    labFormat = labelFormat(suffix = " m")
  ) %>% 
  
  # Polygon layer with ID on hover
  addPolygons(
    data    = polys,
    group   = "Polygons",
    color   = "black",
    weight  = 1,
    fill    = FALSE,
    label   = ~as.character(ID),
    highlightOptions = highlightOptions(
      weight       = 3,
      color        = "red",
      bringToFront = TRUE
    ),
    labelOptions = labelOptions(
      direction = "auto",
      style     = list("font-weight" = "bold")
    )
  ) %>% 
  
  # Allow user to toggle both layers
  addLayersControl(
    baseGroups    = c("Esri Satellite"),
    overlayGroups = c("Bathymetry", "Polygons"),
    options       = layersControlOptions(collapsed = FALSE)
  )


## 4. Add real bathymetry value under cursor (0–30 m) -----------------------

# IMPORTANT: here we use the ORIGINAL `bathy` (0–30 m).
# So the query shows the true depth, even though colours are “compressed” to 0–3.
m <-  m %>%
  # wire up click‐popup: show value with 2 decimals
  addImageQuery(
    # map    = .,
    x = bathy$Bathy_Lagoon_20250613_S2_Swampy,
    project = TRUE,
    layerId= "Bathymetry",
    type   = "mousemove",
    digits = 2,
    prefix = ""
  ) 

m

```

